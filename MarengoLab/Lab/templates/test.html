{% extends 'index.html' %}
{% block content%}

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>First name</th>
            <th>Last name</th>
            <th>Gender</th>
            <th>Details</th>
        </tr>
    </thead>
    <tbody>
        {% for row in rows %}
            <tr>
                <td>{{ row.patient_id}}</td>
                <td>{{ row.f_name }}</td>
                <td>{{ row.l_name }}</td>
                <td>{{ row.gender }}</td>
                <td>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal1{{ row.patient_id }}">
                        Details
                    </button>
                
                <button type="button" class="btn btn-primary" data-bs-toggle="modal"  data-bs-target="#modal2{{ row.patient_id }}">Delete</button>
                <button type="button" class="btn btn-primary"  data-bs-toggle="modal" data-bs-target="#modal3{{row.patient_id}}">Update</button>
        
              </td>
            </tr>

        {% endfor %}
    </tbody>
</table>

{% for row in rows %}
    <div class="modal fade" id="modal1{{ row.patient_id }}" tabindex="-1" role="dialog" aria-labelledby="modal{{ row.patient_id }}Label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal{{ row.patient_id }}Label">Details for Row {{ row.patient_id }}</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Add the details for the row here -->
                    <p>First Name: {{ row.f_name }}</p>
                    <p>Last Name: {{ row.l_name }}</p>
                    <p>Age: {{ row.age }}</p>
                    <p>Gender: {{ row.gender }}</p>
                    <p>Email: {{ row.email }}</p>
                    <p>Telphone Number: {{ row.tel_num }}</p>
                    <p>Comment: {{ row.comment }}</p>
                    <!-- Add more details as needed -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal2{{ row.patient_id }}" tabindex="-1" role="dialog" aria-labelledby="modal{{ row.patient_id }}Label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal{{ row.patient_id }}Label">Details for Row {{ row.patient_id }}</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                 <p>Are you sure you would like to delete the row? </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" data-id="{{ row.patient_id }}" class="delete-button btn btn-secondary " >Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal3{{ row.patient_id }}" tabindex="-1" role="dialog" aria-labelledby="modal{{ row.patient_id }}Label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal{{ row.patient_id }}Label">Details for Row {{ row.patient_id }}</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form class="updateForm" id="updateForm" data-button-id="{{ row.patient_id }}"  method="POST">
                        {% csrf_token %}
                        <input type="text" name="First Name" value="{{ row.f_name }}">
                        <input type="text" name="Last Name" value="{{ row.l_name}}">
                        <input type="text" name="Age" value="{{ row.age }}">
                        <input type="text" name="Email" value="{{ row.email }}">
                        <input type="text" name="Telephone number" value="{{ row.tel_num}}">
                        <input type="text" name="Comment" value="{{ row.comment }}">
                        <button type="submit" data-id="{{ row.patient_id }}"  class="update-button btn btn-secondary" >Update</button>
                    </form>
                </div>
            
                 
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                 </div>
           
               
            </div>
        </div>
    </div>

{% endfor %}

<script>
    // JavaScript code to handle the delete button click event
    
    const deleteButtons = document.querySelectorAll('.delete-button');
    deleteButtons.forEach(button => {
      button.addEventListener('click', () => {
        const id = button.dataset.id;
        var token = "{{ csrf_token }}";
        console.error(token);
        
        
        // Send an AJAX request to delete the row
        // You can use fetch or any other AJAX library to send the request
        fetch(`/delete/${id}`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': token},
            
        })
        .then(response => {
          if (response.ok) {
            // Row deleted successfully, update the UI
            button.closest('tr').remove();
          } else {
            // Handle error response
            console.error('Failed to delete row');
          }
        })
        .catch(error => {
          // Handle network or other errors
          console.error('Failed to delete row', error);
        });
      });
    });
    </script>

<script>
//const form = document.getElementById('updateForm');
//const buttons = document.querySelectorAll('.update-button');




      // Handle error case
      //alert('Failed fetch error ' + error);
    //});
  //});
//});

    

//$('.update-button').on('click', function(e) {

  //var button = document.querySelector('button[type="submit"]');   //new code
  //var id = button.data.id;   
  //alert('this'+ id)   //new code 
  //var button = document.querySelector('button[type="submit"]');
  //var formData = button.closest('form').serialize();   //new code
   

  
  //var formData = $(this).serialize();
  //formData += '&id=' + id;
  //alert('here'+ formData)
  
 


const forms = document.querySelectorAll('.updateForm');
forms.forEach(form => {
  form.addEventListener('submit', function(event) {
    event.preventDefault();
    var submitButton = event.submitter;
  
  // Get the ID of the submit button
    var id = submitButton.dataset.id;
    //var id = button.dataset.id;  
    alert('here'+ id)
    //var formData =  new FormData(document.getElementById('updateForm'));
    var formData =  new FormData(document.querySelector(`form[data-button-id="${id}"]`));
    formData.append('id', id);
    //var form = button.;
    
    var token = "{{ csrf_token }}";
    //formData += '&id=' + id;
    alert('here'+ formData)
    fetch('/update-patient/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': token
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      alert(data)
      if (data.success) {
        // Handle success case
        alert('Model row updated successfully!');
      } else {
        // Handle error case
        alert('Failed to update the model row: ' + data.error);
      }
    })
    .catch(error => {
      // Handle error case
      alert('Failed fetch error ' + error);
    });
  });
});


</script>

{% endblock %}

